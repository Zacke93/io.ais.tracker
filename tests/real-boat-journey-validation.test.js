'use strict';

/**
 * REAL BOAT JOURNEY VALIDATION TEST
 *
 * 100% emulerar den riktiga appen med verkliga AIS-data frÃ¥n loggen.
 * Testar kompletta boat journeys och validerar att bridge text, flow triggers,
 * ETA berÃ¤kningar och all logik fungerar exakt som fÃ¶rvÃ¤ntat.
 *
 * ANVÃ„NDER RIKTIG AIS DATA:
 * - BÃ¥t 219033217: Norrut frÃ¥n 606m â†’ under Olidebron â†’ fortsÃ¤tter norrut
 * - BÃ¥t 211416080: SÃ¶derut frÃ¥n 357m â†’ lÃ¤mnar systemet
 * - BÃ¥t 265573130: Komplett journey genom flera broar
 *
 * 100% REALISTISK EMULERING:
 * - Startar hela app.js med alla services
 * - Injicerar riktiga AIS-meddelanden exakt som appen tar emot dem
 * - Validerar bridge text uppdateringar i real-time
 * - Kontrollerar flow triggers och capabilities
 * - Testar robusthet mot edge cases
 */

const RealAppTestRunner = require('./journey-scenarios/RealAppTestRunner');

describe('ğŸš¢ REAL BOAT JOURNEY VALIDATION - 100% App Emulation', () => {
  let testRunner;
  let journeyReport;

  beforeAll(async () => {
    testRunner = new RealAppTestRunner();
    await testRunner.initializeApp();
  }, 30000); // LÃ¤ngre timeout fÃ¶r app initialization

  afterAll(async () => {
    if (testRunner) {
      await testRunner.cleanup();
    }
  });

  describe('VERKLIG BOAT JOURNEY: BÃ¥t 219033217 - Norrut frÃ¥n Olidebron', () => {

    test('Komplett resa: frÃ¥n 606m sÃ¶der â†’ under Olidebron â†’ fortsÃ¤tter norrut', async () => {
      // RIKTIG AIS DATA frÃ¥n loggen fÃ¶r bÃ¥t 219033217
      const realBoatJourney = [
        {
          description: 'BÃ¥t 219033217 upptÃ¤cks 606m sÃ¶der om Olidebron',
          vessels: [{
            mmsi: '219033217',
            name: 'M/S Test Norrut',
            lat: 58.270500, // 606m sÃ¶der om Olidebron (58.272743)
            lon: 12.273000,
            sog: 5.0,
            cog: 196.5, // SÃ¶derut men kommer vÃ¤nda
          }],
        },
        {
          description: 'BÃ¥ten nÃ¤rmar sig Olidebron (451m)',
          vessels: [{
            mmsi: '219033217',
            name: 'M/S Test Norrut',
            lat: 58.271200, // 451m frÃ¥n Olidebron
            lon: 12.274000,
            sog: 4.9,
            cog: 202.7, // Fortfarande sÃ¶derut men kommer vÃ¤nda
          }],
        },
        {
          description: 'BÃ¥ten gÃ¶r U-svÃ¤ng och bÃ¶rjar kÃ¶ra norrut mot Olidebron',
          vessels: [{
            mmsi: '219033217',
            name: 'M/S Test Norrut',
            lat: 58.271500, // NÃ¤rmare Olidebron
            lon: 12.274200,
            sog: 4.5,
            cog: 20, // NU NORRUT - viktig COG-Ã¤ndring
          }],
        },
        {
          description: 'BÃ¥ten approaching Olidebron (200m) - CRITICAL status change',
          vessels: [{
            mmsi: '219033217',
            name: 'M/S Test Norrut',
            lat: 58.272000, // 200m frÃ¥n Olidebron
            lon: 12.274800,
            sog: 4.0,
            cog: 25, // Norrut mot bron
          }],
        },
        {
          description: 'BÃ¥ten waiting vid Olidebron (150m) - fÃ¶rvÃ¤ntar bridge text',
          vessels: [{
            mmsi: '219033217',
            name: 'M/S Test Norrut',
            lat: 58.272400, // 150m frÃ¥n Olidebron
            lon: 12.275000,
            sog: 0.5, // Saktar ner fÃ¶r vÃ¤ntan
            cog: 30,
          }],
          delaySeconds: 2, // LÃ¥t systemet stabilisera status
        },
        {
          description: 'BÃ¥ten UNDER Olidebron (31m) - KRITISK test fÃ¶r intermediate bridge',
          vessels: [{
            mmsi: '219033217',
            name: 'M/S Test Norrut',
            lat: 58.272743, // EXAKT vid Olidebron
            lon: 12.275115,
            sog: 3.5,
            cog: 35, // Passerar under bron
          }],
          delaySeconds: 1,
        },
        {
          description: "BÃ¥ten passerat Olidebron (80m norr) - 'precis passerat' text",
          vessels: [{
            mmsi: '219033217',
            name: 'M/S Test Norrut',
            lat: 58.273200, // 80m norr om Olidebron
            lon: 12.275400,
            sog: 4.2,
            cog: 40, // FortsÃ¤tter norrut
          }],
        },
        {
          description: 'BÃ¥ten fortsÃ¤tter norrut (300m frÃ¥n Olidebron) - bÃ¶r fÃ¥ targetBridge',
          vessels: [{
            mmsi: '219033217',
            name: 'M/S Test Norrut',
            lat: 58.275000, // 300m norr om Olidebron
            lon: 12.276500,
            sog: 4.8,
            cog: 45, // Norrut mot Klaffbron
          }],
        },
        {
          description: 'BÃ¥ten fÃ¶rsvinner frÃ¥n systemet',
          vessels: [], // TÃ¶m systemet
        },
      ];

      journeyReport = await testRunner.runRealJourney(
        'BÃ¥t 219033217 - Norrut frÃ¥n Olidebron',
        realBoatJourney,
      );

      // KRITISKA VALIDERINGAR

      // 1. Bridge text bÃ¶r ha uppdaterats flera gÃ¥nger under resan
      expect(journeyReport.bridgeTextChanges.length).toBeGreaterThan(3);
      console.log(`âœ… Bridge text updated ${journeyReport.bridgeTextChanges.length} times during journey`);

      // 2. Olidebron bÃ¶r ha omnÃ¤mnts i bridge text (intermediate bridge fix)
      const bridgeTextHistory = journeyReport.bridgeTextChanges.map((c) => c.newText).join(' ');
      expect(bridgeTextHistory.toLowerCase()).toContain('olidebron');
      console.log('âœ… Olidebron mentioned in bridge text (intermediate bridge working)');

      // 3. Ingen "undefinedm" eller system errors
      expect(bridgeTextHistory).not.toContain('undefinedm');
      expect(bridgeTextHistory).not.toContain('undefined');
      console.log('âœ… No "undefinedm" errors in bridge text');

      // 4. System bÃ¶r vara tomt vid slutet
      expect(journeyReport.finalBridgeText).toBe('Inga bÃ¥tar Ã¤r i nÃ¤rheten av Klaffbron eller Stridsbergsbron');
      console.log('âœ… System properly cleaned up after boat left');

      // 5. Validera status-Ã¶vergÃ¥ngar
      const statusTransitions = journeyReport.bridgeTextChanges.filter((change) => change.vessels && change.vessels.length > 0);
      expect(statusTransitions.length).toBeGreaterThan(2);
      console.log(`âœ… ${statusTransitions.length} meaningful status transitions recorded`);

    }, 45000); // LÃ¤ngre timeout fÃ¶r komplett resa
  });

  describe('CONCURRENT VESSELS: TvÃ¥ bÃ¥tar samtidigt', () => {

    test('BÃ¥t 211416080 (sÃ¶derut) + BÃ¥t 219033217 (norrut) samtidigt', async () => {
      const concurrentJourney = [
        {
          description: 'BÃ¥da bÃ¥tarna upptÃ¤cks samtidigt pÃ¥ olika positioner',
          vessels: [
            {
              mmsi: '211416080',
              name: 'M/S Southbound',
              lat: 58.282000, // Norr om Klaffbron
              lon: 12.285000,
              sog: 3.7,
              cog: 199.6, // SÃ¶derut
            },
            {
              mmsi: '219033217',
              name: 'M/S Northbound',
              lat: 58.270000, // SÃ¶der om Olidebron
              lon: 12.272000,
              sog: 5.0,
              cog: 25, // Norrut
            },
          ],
        },
        {
          description: 'BÃ¥da bÃ¥tarna nÃ¤rmar sig sina respektive broar',
          vessels: [
            {
              mmsi: '211416080',
              name: 'M/S Southbound',
              lat: 58.284095, // Approaching Klaffbron
              lon: 12.283929,
              sog: 3.2,
              cog: 195,
            },
            {
              mmsi: '219033217',
              name: 'M/S Northbound',
              lat: 58.272400, // Approaching Olidebron
              lon: 12.275000,
              sog: 4.5,
              cog: 30,
            },
          ],
          delaySeconds: 2,
        },
        {
          description: 'En bÃ¥t under Klaffbron, en under Olidebron - KRITISK concurrent test',
          vessels: [
            {
              mmsi: '211416080',
              name: 'M/S Southbound',
              lat: 58.284095, // Under Klaffbron (target bridge)
              lon: 12.283929,
              sog: 3.0,
              cog: 200,
            },
            {
              mmsi: '219033217',
              name: 'M/S Northbound',
              lat: 58.272743, // Under Olidebron (intermediate bridge)
              lon: 12.275115,
              sog: 3.8,
              cog: 35,
            },
          ],
          delaySeconds: 2,
        },
        {
          description: 'BÃ¥da bÃ¥tarna lÃ¤mnar systemet',
          vessels: [],
        },
      ];

      const concurrentReport = await testRunner.runRealJourney(
        'Concurrent Vessels Test',
        concurrentJourney,
      );

      // CONCURRENT VALIDERING

      // 1. Bridge text bÃ¶r hantera bÃ¥da bÃ¥tarna
      expect(concurrentReport.bridgeTextChanges.length).toBeGreaterThan(2);

      // 2. BÃ¥de target bridge (Klaffbron) och intermediate bridge (Olidebron) bÃ¶r omnÃ¤mnas
      const allBridgeText = concurrentReport.bridgeTextChanges.map((c) => c.newText).join(' ');
      const hasKlaffbron = allBridgeText.includes('Klaffbron');
      const hasOlidebron = allBridgeText.includes('Olidebron');

      expect(hasKlaffbron || hasOlidebron).toBe(true); // Minst en bro bÃ¶r omnÃ¤mnas
      console.log(`âœ… Bridge text mentioned bridges: Klaffbron=${hasKlaffbron}, Olidebron=${hasOlidebron}`);

      // 3. Multi-vessel handling (semikolon eller ytterligare bÃ¥t)
      const hasMultiVesselText = allBridgeText.includes(';') || allBridgeText.includes('ytterligare');
      if (concurrentReport.bridgeTextChanges.some((c) => c.vessels && c.vessels.length > 1)) {
        expect(hasMultiVesselText).toBe(true);
        console.log('âœ… Multi-vessel text formatting working');
      }

      // 4. System cleanup
      expect(concurrentReport.finalBridgeText).toBe('Inga bÃ¥tar Ã¤r i nÃ¤rheten av Klaffbron eller Stridsbergsbron');

    }, 45000);
  });

  describe('BRIDGE TEXT STABILITET & ETA KORREKTHET', () => {

    test('Bridge text fladdrar inte och ETA Ã¤r korrekt', async () => {
      const stabilityJourney = [
        {
          description: 'BÃ¥t approaching Klaffbron - bÃ¶r fÃ¥ stabil bridge text',
          vessels: [{
            mmsi: '265573130',
            name: 'M/S Stability Test',
            lat: 58.281000, // 400m frÃ¥n Klaffbron
            lon: 12.282000,
            sog: 4.0,
            cog: 180, // SÃ¶derut mot Klaffbron
          }],
        },
        {
          description: 'BÃ¥t nÃ¤rmare Klaffbron - bridge text bÃ¶r uppdatera med korrekt ETA',
          vessels: [{
            mmsi: '265573130',
            name: 'M/S Stability Test',
            lat: 58.282500, // 200m frÃ¥n Klaffbron
            lon: 12.283000,
            sog: 3.5, // Saktar ner
            cog: 185,
          }],
          delaySeconds: 3, // LÃ¥t systemet stabilisera
        },
        {
          description: 'BÃ¥t waiting vid Klaffbron - ETA bÃ¶r fÃ¶rsvinna fÃ¶r target bridge',
          vessels: [{
            mmsi: '265573130',
            name: 'M/S Stability Test',
            lat: 58.284000, // 100m frÃ¥n Klaffbron
            lon: 12.283800,
            sog: 0.3, // VÃ¤ntar
            cog: 190,
          }],
          delaySeconds: 5, // LÃ¤ngre delay fÃ¶r waiting status
        },
        {
          description: "BÃ¥t under Klaffbron - 'BroÃ¶ppning pÃ¥gÃ¥r' utan ETA",
          vessels: [{
            mmsi: '265573130',
            name: 'M/S Stability Test',
            lat: 58.284095, // Exakt under Klaffbron
            lon: 12.283929,
            sog: 2.5,
            cog: 195,
          }],
          delaySeconds: 2,
        },
        {
          description: 'Cleanup',
          vessels: [],
        },
      ];

      const stabilityReport = await testRunner.runRealJourney(
        'Bridge Text Stability & ETA Test',
        stabilityJourney,
      );

      // STABILITET VALIDERING

      // 1. Bridge text bÃ¶r ha uppdaterats men inte fladdrat
      expect(stabilityReport.bridgeTextChanges.length).toBeGreaterThan(1);
      expect(stabilityReport.bridgeTextChanges.length).toBeLessThan(10); // Inte fÃ¶r mÃ¥nga Ã¤ndringar
      console.log(`âœ… Bridge text updates: ${stabilityReport.bridgeTextChanges.length} (stable, not flickering)`);

      // 2. ETA-hantering fÃ¶r target bridge
      const bridgeTexts = stabilityReport.bridgeTextChanges.map((c) => c.newText);

      // Approaching phase bÃ¶r ha ETA
      const approachingTexts = bridgeTexts.filter((text) => text.includes('nÃ¤rmar sig') && text.includes('Klaffbron'));
      if (approachingTexts.length > 0) {
        const hasETA = approachingTexts.some((text) => text.includes('minut'));
        expect(hasETA).toBe(true);
        console.log('âœ… Approaching phase has ETA');
      }

      // Waiting/under-bridge fÃ¶r target bridge bÃ¶r INTE ha ETA
      const waitingTexts = bridgeTexts.filter((text) => text.includes('invÃ¤ntar broÃ¶ppning vid Klaffbron') || text.includes('pÃ¥gÃ¥r vid Klaffbron'));
      if (waitingTexts.length > 0) {
        const hasNoETA = waitingTexts.every((text) => !text.includes('berÃ¤knad broÃ¶ppning'));
        expect(hasNoETA).toBe(true);
        console.log('âœ… Target bridge waiting/under-bridge has no ETA');
      }

      // 3. Textformat Ã¤r korrekt svensk
      const finalTexts = bridgeTexts.filter((text) => !text.includes('Inga bÃ¥tar'));
      finalTexts.forEach((text) => {
        expect(text).toMatch(/bÃ¥t/); // Contains "bÃ¥t"
        expect(text).not.toContain('undefined');
        expect(text).not.toContain('null');
        expect(text).not.toContain('NaN');
      });
      console.log('âœ… All bridge texts are properly formatted Swedish');

    }, 45000);
  });
});
