'use strict';

/**
 * EDGE CASES & ROBUSTNESS VALIDATION TEST
 *
 * Testar appens robusthet mot alla edge cases som du specificerade:
 * 1. BÃ¥tar som ankrar utanfÃ¶r skyddszon - systemet tar bort dem korrekt
 * 2. BÃ¥tar som gÃ¶r skarva svÃ¤ngningar/U-turn - INTE tolkade som GPS-hopp
 * 3. Riktiga GPS-hopp - korrekt upptÃ¤ckta och hanterade
 * 4. Flow triggers under stress och edge conditions
 * 5. Minnestester och prestanda under load
 *
 * 100% REAL APP EMULATION med extrema scenarios.
 */

const RealAppTestRunner = require('./journey-scenarios/RealAppTestRunner');

describe('ðŸ”§ EDGE CASES & ROBUSTNESS VALIDATION - Real App Stress Tests', () => {
  let testRunner;

  beforeAll(async () => {
    testRunner = new RealAppTestRunner();
    await testRunner.initializeApp();
  }, 30000);

  afterAll(async () => {
    if (testRunner) {
      await testRunner.cleanup();
    }
  });

  describe('ANKRING & CLEANUP: BÃ¥tar utanfÃ¶r skyddszon', () => {

    test('BÃ¥t ankrar 2km utanfÃ¶r skyddszon - systemet bÃ¶r ta bort den', async () => {
      const anchoringScenario = [
        {
          description: 'BÃ¥t approaching Klaffbron',
          vessels: [{
            mmsi: '999888777',
            name: 'M/S Future Anchor',
            lat: 58.282000,
            lon: 12.282000,
            sog: 4.5,
            cog: 180,
          }],
        },
        {
          description: 'BÃ¥t passerar Klaffbron och fortsÃ¤tter sÃ¶derut',
          vessels: [{
            mmsi: '999888777',
            name: 'M/S Future Anchor',
            lat: 58.284095, // Vid Klaffbron
            lon: 12.283929,
            sog: 3.8,
            cog: 185,
          }],
        },
        {
          description: 'BÃ¥t fortsÃ¤tter sÃ¶derut utanfÃ¶r systemet',
          vessels: [{
            mmsi: '999888777',
            name: 'M/S Future Anchor',
            lat: 58.270000, // SÃ¶der om alla broar
            lon: 12.270000,
            sog: 4.0,
            cog: 190,
          }],
        },
        {
          description: 'BÃ¥t ankrar FAR UTANFÃ–R skyddszon (2km frÃ¥n nÃ¤rmaste bro)',
          vessels: [{
            mmsi: '999888777',
            name: 'M/S Future Anchor',
            lat: 58.250000, // 2+ km sÃ¶der om Olidebron
            lon: 12.250000,
            sog: 0.0, // ANKRAD - noll hastighet
            cog: 0, // Ingen kurs nÃ¤r ankrad
          }],
          delaySeconds: 3, // LÃ¥t timeout-logiken kicka in
        },
        {
          description: 'VÃ¤ntar fÃ¶r att lÃ¥ta cleanup timeout kÃ¶ra',
          vessels: [{
            mmsi: '999888777',
            name: 'M/S Future Anchor',
            lat: 58.250000, // Samma position - fortfarande ankrad
            lon: 12.250000,
            sog: 0.1, // Minimal rÃ¶relse (som en ankrad bÃ¥t)
            cog: 5,
          }],
          delaySeconds: 8, // LÃ¤ngre delay fÃ¶r timeout
        },
        {
          description: 'Kontrollera att bÃ¥ten tagits bort frÃ¥n systemet',
          vessels: [], // Ingen vessel input - bara kontrollera status
        },
      ];

      const anchorReport = await testRunner.runRealJourney(
        'Anchoring Cleanup Test',
        anchoringScenario,
      );

      // VALIDERING: BÃ¥t bÃ¶r ha tagits bort av timeout-logiken
      expect(anchorReport.finalBridgeText).toBe('Inga bÃ¥tar Ã¤r i nÃ¤rheten av Klaffbron eller Stridsbergsbron');

      // Bridge text bÃ¶r ha uppdaterats nÃ¤r bÃ¥ten fÃ¶rst upptÃ¤cktes, sen tagits bort
      expect(anchorReport.bridgeTextChanges.length).toBeGreaterThan(0);
      console.log('âœ… Anchored boat outside protection zone was properly removed');

    }, 45000);

    test('BÃ¥t ankrar INOM skyddszon - systemet bÃ¶r INTE ta bort den', async () => {
      const protectedAnchorScenario = [
        {
          description: 'BÃ¥t approaching Klaffbron',
          vessels: [{
            mmsi: '555444333',
            name: 'M/S Protected Anchor',
            lat: 58.283000,
            lon: 12.283000,
            sog: 3.5,
            cog: 180,
          }],
        },
        {
          description: 'BÃ¥t ankrar 200m frÃ¥n Klaffbron (INOM skyddszon)',
          vessels: [{
            mmsi: '555444333',
            name: 'M/S Protected Anchor',
            lat: 58.282500, // 200m frÃ¥n Klaffbron
            lon: 12.283500,
            sog: 0.0, // Ankrad
            cog: 0,
          }],
          delaySeconds: 10, // LÃ¥ngt delay fÃ¶r timeout test
        },
        {
          description: 'Kontrollera att bÃ¥ten KVARSTÃ…R i systemet',
          vessels: [{
            mmsi: '555444333',
            name: 'M/S Protected Anchor',
            lat: 58.282500, // Samma position
            lon: 12.283500,
            sog: 0.1,
            cog: 5,
          }],
        },
      ];

      const protectedReport = await testRunner.runRealJourney(
        'Protected Anchoring Test',
        protectedAnchorScenario,
      );

      // VALIDERING: BÃ¥t inom skyddszon bÃ¶r INTE tas bort
      expect(protectedReport.finalBridgeText).not.toBe('Inga bÃ¥tar Ã¤r i nÃ¤rheten av Klaffbron eller Stridsbergsbron');
      console.log('âœ… Anchored boat within protection zone was preserved');

    }, 45000);
  });

  describe('SVÃ„NGNINGAR & GPS-HOPP: Korrekt tolkning av rÃ¶relser', () => {

    test('BÃ¥t gÃ¶r skarp U-svÃ¤ng - bÃ¶r INTE tolkas som GPS-hopp', async () => {
      const uTurnScenario = [
        {
          description: 'BÃ¥t going sÃ¶derut mot Klaffbron',
          vessels: [{
            mmsi: '777666555',
            name: 'M/S U-Turner',
            lat: 58.286000, // Norr om Klaffbron
            lon: 12.285000,
            sog: 4.5,
            cog: 180, // SÃ¶derut
          }],
        },
        {
          description: 'BÃ¥t nÃ¤rmar sig Klaffbron',
          vessels: [{
            mmsi: '777666555',
            name: 'M/S U-Turner',
            lat: 58.284500, // NÃ¤rmare Klaffbron
            lon: 12.284500,
            sog: 4.0,
            cog: 185,
          }],
        },
        {
          description: 'BÃ¥t gÃ¶r SKARP U-SVÃ„NG (180Â° COG change) - KRITISK test',
          vessels: [{
            mmsi: '777666555',
            name: 'M/S U-Turner',
            lat: 58.284200, // Lite nÃ¤rmare bron
            lon: 12.284200,
            sog: 2.5, // Saktar fÃ¶r svÃ¤ngen
            cog: 5, // 180Â° Ã„NDRING frÃ¥n 185Â° â†’ 005Â° (NORRUT)
          }],
          delaySeconds: 2,
        },
        {
          description: 'BÃ¥t fortsÃ¤tter norrut efter U-svÃ¤ngen',
          vessels: [{
            mmsi: '777666555',
            name: 'M/S U-Turner',
            lat: 58.285000, // Norrut frÃ¥n Klaffbron
            lon: 12.285500,
            sog: 4.2, // Normal hastighet igen
            cog: 10, // Fortsatt norrut
          }],
        },
      ];

      const uTurnReport = await testRunner.runRealJourney(
        'U-Turn Test (NOT GPS Jump)',
        uTurnScenario,
      );

      // VALIDERING: U-turn bÃ¶r INTE ha tolkats som GPS-hopp
      // Bridge text bÃ¶r ha uppdaterats normalt genom hela sekvensen
      expect(uTurnReport.bridgeTextChanges.length).toBeGreaterThan(1);

      // Inga GPS-hopp fel bÃ¶r ha loggats
      const allBridgeText = uTurnReport.bridgeTextChanges.map((c) => c.newText).join(' ');
      expect(allBridgeText).not.toContain('GPS');
      expect(allBridgeText).not.toContain('hopp');

      console.log('âœ… Sharp U-turn was NOT interpreted as GPS jump');
      console.log(`âœ… ${uTurnReport.bridgeTextChanges.length} normal bridge text updates during U-turn`);

    }, 45000);

    test('Riktig GPS-hopp (2km teleportation) - bÃ¶r upptÃ¤ckas och hanteras', async () => {
      const gpsJumpScenario = [
        {
          description: 'BÃ¥t normal position vid Klaffbron',
          vessels: [{
            mmsi: '333222111',
            name: 'M/S GPS Jumper',
            lat: 58.284095, // Vid Klaffbron
            lon: 12.283929,
            sog: 3.5,
            cog: 190,
          }],
        },
        {
          description: 'RIKTIG GPS-HOPP: BÃ¥t teleporterar 2km norrut (omÃ¶jlig rÃ¶relse)',
          vessels: [{
            mmsi: '333222111',
            name: 'M/S GPS Jumper',
            lat: 58.310000, // 2+ km norr om alla broar (TELEPORTATION)
            lon: 12.320000,
            sog: 3.8, // Samma hastighet (visar att det Ã¤r GPS-fel)
            cog: 185, // Samma riktning
          }],
          delaySeconds: 3,
        },
        {
          description: 'BÃ¥t tillbaka till normal position (GPS korrigerat)',
          vessels: [{
            mmsi: '333222111',
            name: 'M/S GPS Jumper',
            lat: 58.284500, // Tillbaka nÃ¤ra Klaffbron
            lon: 12.284200,
            sog: 3.7,
            cog: 192,
          }],
        },
      ];

      const gpsJumpReport = await testRunner.runRealJourney(
        'Real GPS Jump Test',
        gpsJumpScenario,
      );

      // VALIDERING: System bÃ¶r ha hanterat GPS-hoppet
      // Minst en bridge text update, men systemet bÃ¶r vara robust
      expect(gpsJumpReport.bridgeTextChanges.length).toBeGreaterThan(0);

      // Final state bÃ¶r vara korrekt
      expect(typeof gpsJumpReport.finalBridgeText).toBe('string');

      console.log('âœ… Real GPS jump was detected and handled gracefully');
      console.log(`Final bridge text: "${gpsJumpReport.finalBridgeText}"`);

    }, 45000);
  });

  describe('FLOW TRIGGERS UNDER STRESS', () => {

    test('Rapid vessel changes - flow triggers bÃ¶r vara stabila', async () => {
      const rapidChangesScenario = [
        {
          description: 'BÃ¥t 1 approaching Klaffbron',
          vessels: [{
            mmsi: '111',
            name: 'Rapid 1',
            lat: 58.282000,
            lon: 12.282000,
            sog: 4.0,
            cog: 180,
          }],
        },
        {
          description: 'BÃ¥t 2 approaching Stridsbergsbron',
          vessels: [
            {
              mmsi: '111',
              name: 'Rapid 1',
              lat: 58.283000,
              lon: 12.283000,
              sog: 3.8,
              cog: 185,
            },
            {
              mmsi: '222',
              name: 'Rapid 2',
              lat: 58.292000,
              lon: 12.293000,
              sog: 4.2,
              cog: 220,
            },
          ],
        },
        {
          description: 'BÃ¥t 3 approaching Olidebron + rapid status changes',
          vessels: [
            {
              mmsi: '111',
              name: 'Rapid 1',
              lat: 58.284095, // Under Klaffbron
              lon: 12.283929,
              sog: 3.5,
              cog: 190,
            },
            {
              mmsi: '222',
              name: 'Rapid 2',
              lat: 58.293524, // Under Stridsbergsbron
              lon: 12.294566,
              sog: 4.0,
              cog: 225,
            },
            {
              mmsi: '333',
              name: 'Rapid 3',
              lat: 58.271000, // Approaching Olidebron
              lon: 12.274000,
              sog: 3.9,
              cog: 35,
            },
          ],
        },
        {
          description: 'Alla bÃ¥tar fÃ¶rsvinner snabbt (stress cleanup)',
          vessels: [],
        },
      ];

      const rapidReport = await testRunner.runRealJourney(
        'Rapid Changes Flow Triggers Test',
        rapidChangesScenario,
      );

      // VALIDERING: Flow triggers bÃ¶r ha fungerat utan krascher
      expect(rapidReport.bridgeTextChanges.length).toBeGreaterThan(2);

      // Inga system errors
      const allTexts = rapidReport.bridgeTextChanges.map((c) => c.newText);
      allTexts.forEach((text) => {
        expect(text).not.toContain('undefined');
        expect(text).not.toContain('error');
        expect(text).not.toContain('null');
      });

      console.log('âœ… Flow triggers stable under rapid vessel changes');
      console.log(`âœ… ${rapidReport.bridgeTextChanges.length} bridge text updates without errors`);

    }, 45000);

    test('Invalid vessel data - systemet bÃ¶r vara robust', async () => {
      const invalidDataScenario = [
        {
          description: 'Normal bÃ¥t fÃ¶rst',
          vessels: [{
            mmsi: '999000111',
            name: 'Normal Boat',
            lat: 58.284000,
            lon: 12.284000,
            sog: 3.5,
            cog: 180,
          }],
        },
        {
          description: 'BÃ¥t med invalid/extreme data',
          vessels: [
            {
              mmsi: '999000111',
              name: 'Normal Boat',
              lat: 58.284095,
              lon: 12.283929,
              sog: 3.2,
              cog: 185,
            },
            {
              mmsi: '999000222',
              name: 'Invalid Boat',
              lat: 999.999999, // INVALID latitude
              lon: -999.999999, // INVALID longitude
              sog: -50, // NEGATIVE speed
              cog: 720, // INVALID course (>360Â°)
            },
          ],
        },
        {
          description: 'BÃ¥t med null/undefined values',
          vessels: [
            {
              mmsi: '999000111',
              name: 'Normal Boat',
              lat: 58.284200,
              lon: 12.284100,
              sog: 3.0,
              cog: 190,
            },
            // Note: Vi kan inte injicera null/undefined via AIS message format,
            // men systemet bÃ¶r hantera detta gracefully
          ],
        },
      ];

      const invalidReport = await testRunner.runRealJourney(
        'Invalid Data Robustness Test',
        invalidDataScenario,
      );

      // VALIDERING: System bÃ¶r ha fortsatt fungera trots invalid data
      expect(invalidReport.bridgeTextChanges.length).toBeGreaterThan(0);

      // Normal bÃ¥t bÃ¶r fortfarande fungera
      const normalBoatWorking = invalidReport.bridgeTextChanges.some((change) => change.vessels && change.vessels.some((v) => v.mmsi === '999000111'));
      expect(normalBoatWorking).toBe(true);

      console.log('âœ… System robust against invalid vessel data');

    }, 45000);
  });

  describe('MINNE & PRESTANDA UNDER LOAD', () => {

    test('MÃ¥nga bÃ¥tar samtidigt - systemet bÃ¶r vara stable', async () => {
      // Skapa mÃ¥nga bÃ¥tar pÃ¥ olika positioner
      const manyBoatsPositions = [];
      for (let i = 0; i < 15; i++) {
        manyBoatsPositions.push({
          mmsi: `load_test_${i}`,
          name: `Load Test Boat ${i}`,
          lat: 58.270000 + (i * 0.002), // Spread lÃ¤ngs kanalen
          lon: 12.270000 + (i * 0.002),
          sog: 2.5 + (i * 0.3),
          cog: 180 + (i * 5),
        });
      }

      const loadTestScenario = [
        {
          description: '15 bÃ¥tar entering systemet samtidigt',
          vessels: manyBoatsPositions,
        },
        {
          description: 'Alla bÃ¥tar rÃ¶r sig (update storm)',
          vessels: manyBoatsPositions.map((boat) => ({
            ...boat,
            lat: boat.lat + 0.001, // Alla rÃ¶r sig lite
            lon: boat.lon + 0.0005,
            sog: boat.sog + 0.2,
          })),
          delaySeconds: 3,
        },
        {
          description: 'Cleanup alla bÃ¥tar',
          vessels: [],
        },
      ];

      const startTime = Date.now();
      const loadReport = await testRunner.runRealJourney(
        'Load Test - Many Boats',
        loadTestScenario,
      );
      const endTime = Date.now();
      const totalDuration = endTime - startTime;

      // PRESTANDA VALIDERING
      expect(totalDuration).toBeLessThan(30000); // BÃ¶r ta mindre Ã¤n 30 sekunder
      console.log(`âœ… Load test completed in ${totalDuration}ms`);

      // System bÃ¶r ha hanterat mÃ¥nga bÃ¥tar utan krascher
      expect(loadReport.bridgeTextChanges.length).toBeGreaterThan(0);

      // Final cleanup bÃ¶r fungera
      expect(loadReport.finalBridgeText).toBe('Inga bÃ¥tar Ã¤r i nÃ¤rheten av Klaffbron eller Stridsbergsbron');

      console.log(`âœ… System handled ${manyBoatsPositions.length} boats simultaneously`);
      console.log(`âœ… Bridge text updates: ${loadReport.bridgeTextChanges.length}`);

    }, 60000); // LÃ¤ngre timeout fÃ¶r load test
  });
});
